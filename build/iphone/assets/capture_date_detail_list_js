var win=Ti.UI.currentWindow;var alert_dialog=Ti.UI.createAlertDialog({title:win.title,message:''});var hint_message=L("memo_search_hint_text");var search_bar=Ti.UI.createSearchBar({barColor:win.barColor,showCancel:false,hintText:hint_message});search_bar.addEventListener('change',function(e){e.value;});search_bar.addEventListener('return',function(e){search_bar.blur();});search_bar.addEventListener('cancel',function(e){search_bar.blur();});search_bar.addEventListener('set_color',function(e){search_bar.barColor=win.barColor;});var data=[];var db_array=[];var tableView=Ti.UI.createTableView({data:data,editable:true,allowsSelectionDuringEditing:true,search:search_bar,filterAttribute:'filter',searchHidden:true});var actInd=Ti.UI.createActivityIndicator({bottom:10,height:50,width:10,style:Ti.UI.iPhone.ActivityIndicatorStyle.PLAIN});function setData()
{var db=Ti.Database.open('image.db');var sql_str='SELECT * FROM t_image WHERE entry_date = ? ORDER BY id DESC';var rows=db.execute(sql_str,win.title);while(rows.isValidRow()){var t_data=Ti.UI.createTableViewRow({layout:'absolute',backgroundColor:'#fff',selectedBackgroundColor:'#ddd',height:90,className:'datarow',clickName:'row',text:rows.fieldByName('entry_date')+" "+rows.fieldByName('entry_time')});var thumb_file=rows.fieldByName('filename');var tf=Ti.Filesystem.getFile(Ti.Filesystem.applicationDataDirectory,thumb_file.substr(0,14)+'.png');var thumb_photo=Ti.UI.createImageView({image:tf.nativePath,top:5,left:5,width:'auto',height:'auto',clickName:'thumb_photo'});if(thumb_photo.size.width<thumb_photo.size.height){thumb_photo.width=60;thumb_photo.height=80;}else{thumb_photo.top=22.5;thumb_photo.width=60;thumb_photo.height=45;}
t_data.add(thumb_photo);var filename=Ti.UI.createLabel({color:'#576996',font:{fontSize:16,fontWeight:'bold',fontFamily:'Arial'},left:70,top:2,height:18,width:215,clickName:'filename',highlightedColor:'#fff',text:rows.fieldByName('filename')});t_data.add(filename);var fontSize=14;var memo=Ti.UI.createLabel({color:'#222',backgroundColor:'#fcfcfc',font:{fontSize:fontSize,fontWeight:'normal',fontFamily:'Arial'},left:70,top:20,height:50,width:195,clickName:'memo',highlightedColor:'#00f',text:rows.fieldByName('memo')});t_data.filter=memo.text;t_data.add(memo);var button=Ti.UI.createView({backgroundImage:'./icon_arrow_right.png',backgroundColor:'#00f',top:30,right:5,width:30,clickName:'button',height:30});t_data.add(button);var date=Ti.UI.createLabel({color:'#999',font:{fontSize:12,fontWeight:'normal',fontFamily:'Arial'},left:70,bottom:5,height:15,width:215,clickName:'date',highlightedColor:'#fff',text:rows.fieldByName('entry_date')+" "+rows.fieldByName('entry_time')});t_data.add(date);data.push(t_data);db_array.push(rows.fieldByName('id'));rows.next();}
rows.close();db.close();tableView.setData(data);search_bar.barColor=win.barColor;}
tableView.addEventListener('click',function(e)
{var index=e.index;var section=e.section;var row=e.row;var rowdata=e.rowData;var source=e.source;switch(source.clickName){case"memo":var messageWindow=Ti.UI.createWindow({url:'message_window.js',title:L("memo_title_text"),image_id:db_array[e.index],backgroundColor:'#fff'});Ti.UI.currentTab.open(messageWindow,{animated:true});break;default:var imageWindow=Ti.UI.createWindow({url:'capture_view.js',title:row.text,image_file:row.text,image_id:db_array[e.index]});Ti.UI.currentTab.open(imageWindow);}});tableView.addEventListener('delete',function(e)
{var s=e.section;var db=Ti.Database.open('image.db');var rows=db.execute('SELECT *  FROM t_image WHERE id = ?',db_array[e.index]);while(rows.isValidRow()){var image_file=rows.fieldByName('filename');var img_jpg=Ti.Filesystem.getFile(Ti.Filesystem.applicationDataDirectory,image_file);img_jpg.deleteFile();var img_png=Ti.Filesystem.getFile(Ti.Filesystem.applicationDataDirectory,image_file.substr(0,14)+'.png');img_png.deleteFile();rows.next();}
rows.close();db.execute('DELETE FROM t_image WHERE id = ?',db_array[e.index]);db_array.splice([e.index],1);alert_dialog.message=db.rowsAffected+L("delete_message_text");alert_dialog.show();db.close();});win.add(tableView);win.addEventListener('focus',function(e)
{Ti.API.debug(win.title+' focus:'+tableView.data.length);actInd.style=Ti.UI.iPhone.ActivityIndicatorStyle.DARK;actInd.font={fontFamily:'Helvetica Neue',fontSize:15,fontWeight:'bold'};actInd.color='gray';actInd.message='Loading...';actInd.width=210;actInd.show();win.add(actInd);win.toolbar=[flexSpace,search_btn,flexSpace];setData();var s=setInterval(function(){Ti.API.debug(win.title+' win.count :'+win.count);Ti.API.debug(win.title+' timer :'+data.length);if(data.length>=win.count){Ti.API.debug(win.title+' timer stop:'+data.length);actInd.message=null;actInd.hide();win.remove(actInd);clearInterval(s);s=null;}else{Ti.API.debug(win.title+' timer don\'t stop:'+data.length);}},100);Ti.API.debug(win.title+' focus:'+tableView.data.length);});win.addEventListener('blur',function(e)
{Ti.API.debug(win.title+' blur:'+tableView.data.length);tableView.setData([]);data=[];db_array=[];Ti.API.debug(win.title+' blur:'+tableView.data.length);});win.addEventListener('open',function(e)
{Ti.API.debug(win.title+' open:'+tableView.data.length);});win.addEventListener('close',function(e)
{Ti.API.debug(win.title+' close.');});var edit=Ti.UI.createButton({title:'Edit'});edit.addEventListener('click',function()
{win.setRightNavButton(cancel);tableView.editing=true;});var cancel=Ti.UI.createButton({title:'Cancel',style:Ti.UI.iPhone.SystemButtonStyle.DONE});cancel.addEventListener('click',function()
{win.setRightNavButton(edit);tableView.editing=false;});win.setRightNavButton(edit);var refresh_btn=Ti.UI.createButton({systemButton:Ti.UI.iPhone.SystemButton.REFRESH});var search_btn=Ti.UI.createButton({systemButton:Ti.UI.iPhone.SystemButton.SEARCH});var flexSpace=Ti.UI.createButton({systemButton:Ti.UI.iPhone.SystemButton.FLEXIBLE_SPACE});var nativespinner=Ti.UI.createButton({systemButton:Ti.UI.iPhone.SystemButton.SPINNER});refresh_btn.addEventListener('click',function()
{tableView.setData([]);data=[];db_array=[];setData();});search_btn.addEventListener('click',function()
{if(tableView.searchHidden==true){tableView.scrollToTop(0,{animated:true});search_bar.fireEvent('set_color',{barColor:'#999'});}});