var win=Ti.UI.currentWindow;var navActInd=Ti.UI.createActivityIndicator();win.setRightNavButton(navActInd);navActInd.show();var db=Ti.Database.install('./image.db','image.db');var data=[];function setData(data_i){var db=Ti.Database.open('image.db');switch(data_i){case 0:var rows=db.execute('SELECT count(id) as cnt FROM t_image');var title_txt=L("capture_menu_text");var row_color='red';break;case 1:var rows=db.execute('SELECT count(id) as cnt FROM t_image');var title_txt=L("date_list_menu_text");var row_color='green';break;case 2:var rows=db.execute('SELECT count(id) as cnt FROM t_image WHERE memo IS NOT NULL');var title_txt=L("date_list_with_memo");var row_color='blue';break;case 3:var rows=db.execute('SELECT COUNT(DISTINCT(entry_date)) AS cnt FROM t_image');var title_txt=L("date_group_list");var row_color='orange';break;case 4:var rows=db.execute('SELECT count(id) as cnt FROM t_image');var title_txt="CoverFlowView";var row_color='gray';break;case 5:var rows=db.execute('SELECT count(id) as cnt FROM t_image');var title_txt="";var row_color='gray';break;case 6:var rows=db.execute('SELECT count(id) as cnt FROM t_image');var title_txt="";var row_color='gray';break;}
while(rows.isValidRow()){switch(data_i){case 1:case 2:case 3:case 4:var memo_text=rows.fieldByName('cnt');var rec_count=rows.fieldByName('cnt');break;default:var memo_text="";var rec_count=0;}
var t_data=Ti.UI.createTableViewRow({layout:'absolute',backgroundColor:'#fff',selectedBackgroundColor:'#ddd',height:45,className:'datarow',clickName:rec_count,color:row_color,title:title_txt});switch(data_i){case 0:t_data.header=L("capture_header");break;case 1:var memo=Ti.UI.createLabel({color:'yellow',backgroundColor:'red',borderColor:'red',borderWidth:1,borderRadius:4,font:{fontSize:20},top:5,right:10,width:35,height:35,textAlign:'center',clickName:rec_count,text:memo_text});t_data.add(memo);t_data.header=L("data_list_header");break;case 2:case 3:var memo=Ti.UI.createLabel({color:'yellow',backgroundColor:'red',borderColor:'red',borderWidth:1,borderRadius:4,font:{fontSize:20},top:5,right:10,width:35,height:35,textAlign:'center',clickName:rec_count,text:memo_text});t_data.add(memo);break;case 4:t_data.header=L("coverflow_header");break;case 5:var memo=Ti.UI.createLabel({color:'gray',backgroundColor:'#fff',selectedBackgroundColor:'#ddd',font:{fontSize:14},top:0,left:10,width:320,height:45,textAlign:'left',clickName:rec_count,text:L("photo2gallery")});t_data.add(memo);t_data.header=L("data_operation_header");break;case 6:var memo=Ti.UI.createLabel({color:'red',backgroundColor:'#fff',selectedBackgroundColor:'#ddd',font:{fontSize:14,fontWeight:'bold'},top:0,left:10,width:320,height:45,textAlign:'left',clickName:rec_count,text:L("delete_text")});t_data.add(memo);break;}
data.push(t_data);rows.next();}
rows.close();db.close();}
win.addEventListener('focus',function(e)
{Ti.API.debug(win.title+' focus:'+tableView.data.length);setData(0);setData(1);setData(2);setData(3);setData(4);setData(5);setData(6);tableView.setData(data);Ti.API.debug(win.title+' focus:'+tableView.data.length);});win.addEventListener('blur',function(e)
{Ti.API.debug(win.title+' blur:'+tableView.data.length);tableView.setData([]);data=[];Ti.API.debug(win.title+' blur:'+tableView.data.length);});win.addEventListener('open',function(e)
{Ti.API.debug(win.title+' open:'+tableView.data.length);});win.addEventListener('close',function(e)
{Ti.API.debug(win.title+' close.');});var tableView=Ti.UI.createTableView({data:data});var alert_dialog=Ti.UI.createAlertDialog({title:win.title,message:''});tableView.addEventListener('click',function(e)
{var index=e.index;var section=e.section;var row=e.row;var rowdata=e.rowData;var source=e.source;Ti.API.debug('source '+source.clickName);switch(e.index){case 0:var capWindow=Ti.UI.createWindow({url:'capture.js',title:L("capture_menu_text")});Ti.UI.currentTab.open(capWindow);break;case 1:var imageListWindow=Ti.UI.createWindow({url:'capture_list3.js',title:L("date_list_menu_text"),count:source.clickName,memo:false});Ti.UI.currentTab.open(imageListWindow);break;case 2:var memoListWindow=Ti.UI.createWindow({url:'capture_list3.js',title:L("date_list_with_memo"),count:source.clickName,memo:true});Ti.UI.currentTab.open(memoListWindow);break;case 3:var memoListWindow=Ti.UI.createWindow({url:'capture_date_list.js',title:L("date_group_list"),count:source.clickName});Ti.UI.currentTab.open(memoListWindow);break;case 4:var coverFlowView=Ti.UI.createWindow({url:'coverflow_view.js',title:"CoverFlowView",count:source.clickName});Ti.UI.currentTab.open(coverFlowView);break;case 5:var alertDialog=Ti.UI.createAlertDialog({title:win.title,message:L('photo2gallery_dialog'),buttonNames:['CANCEL','OK'],cancel:0});alertDialog.addEventListener('click',function(event){if(event.cancel){}
if(event.index==1){var photo2galleryWindow=Ti.UI.createWindow({url:'photo2gallery.js',title:L("photo2gallery"),count:source.clickName});Ti.UI.currentTab.open(photo2galleryWindow);}});alertDialog.show();break;case 6:var alertDialog_delete=Ti.UI.createAlertDialog({title:L('delete_text'),message:L('delete_dialog'),buttonNames:['CANCEL','OK'],cancel:0});var alertDialog_delete_final=Ti.UI.createAlertDialog({title:L('delete_dialog_again_title'),message:L('delete_dialog_again'),buttonNames:['CANCEL','OK'],cancel:0});alertDialog_delete.addEventListener('click',function(event){if(event.cancel){}
if(event.index==1){alertDialog_delete_final.show();}});alertDialog_delete_final.addEventListener('click',function(event){if(event.cancel){}
if(event.index==1){var dir=Ti.Filesystem.getFile(Ti.Filesystem.applicationDataDirectory);var filesArray=dir.getDirectoryListing();for(var i=0;i<filesArray.length;i++){var file=Ti.Filesystem.getFile(Ti.Filesystem.applicationDataDirectory,filesArray[i]);if((file.extension()=="jpg")||(file.extension()=="png")){var fname=file.name;file.deleteFile();}}
var db=Ti.Database.open('image.db');db.execute('DELETE FROM t_image');db.execute('VACUUM');db.close();alert(L("delete_complete"));win.fireEvent('blur');win.fireEvent('focus');}});alertDialog_delete.show();break;}});win.add(tableView);var s=setInterval(function(){Ti.API.debug(win.title+' timer :'+data.length);if(data.length>=7){Ti.API.debug(win.title+' timer stop:'+data.length);navActInd.hide();win.setRightNavButton(null);clearInterval(s);s=null;}},100);