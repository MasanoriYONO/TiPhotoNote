var win=Ti.UI.currentWindow;var db=Ti.Database.open('image.db');var sql_str="CREATE TABLE IF NOT EXISTS 't_image_label' (id INTEGER PRIMARY KEY AUTOINCREMENT,\
     photo_id INTEGER,label_index INTEGER,cur_x INTEGER,cur_y INTEGER,text_color TEXT,\
     text_size INTEGER,back_color TEXT, label_memo TEXT,\
     entry_date TEXT,entry_time TEXT)";db.execute(sql_str);db.close();var alert_dialog=Ti.UI.createAlertDialog({title:win.title,message:''});var navActInd=Ti.UI.createActivityIndicator();win.setRightNavButton(navActInd);navActInd.show();var scrollView=Ti.UI.createScrollView({contentWidth:'auto',contentHeight:'auto',top:0,bottom:0,backgroundColor:'gray',showVerticalScrollIndicator:true,showHorizontalScrollIndicator:true,maxZoomScale:10,minZoomScale:0.1});var imageView=Ti.UI.createImageView({width:'auto',height:'auto',top:0,left:0});var filename;var memo_text;var entry_date_time;var db=Ti.Database.open('image.db');var rows=db.execute('SELECT * FROM t_image WHERE id = ? LIMIT 1',win.image_id);while(rows.isValidRow()){filename=rows.fieldByName('filename');memo_text=rows.fieldByName('memo');entry_date_time=rows.fieldByName('entry_date')+' '+rows.fieldByName('entry_time');rows.next();}
rows.close();db.close();var image_file=Ti.Filesystem.getFile(Ti.Filesystem.applicationDataDirectory,filename);imageView.image=image_file.nativePath;imageView.addEventListener('load',function()
{Ti.API.debug('image size width:'+imageView.size.width+' height:'+imageView.size.height);Ti.API.debug('scrollView contentWidth:'+scrollView.contentWidth+' contentHeight:'+scrollView.contentHeight);Ti.API.debug('image top:'+imageView.top+' left:'+imageView.left);Ti.API.debug('Ti.Platform.displayCaps.platformWidth:'+Ti.Platform.displayCaps.platformWidth);scrollView.zoomScale=Ti.Platform.displayCaps.platformWidth/imageView.size.width;Ti.API.debug('scrollView.zoomScale:'+scrollView.zoomScale);navActInd.hide();});var memo_label=Ti.UI.createLabel({id:'memo_label',text:memo_text,width:1200,height:80,top:10,left:10,font:{fontSize:50},color:'white',opacity:0.5,textAlign:'left'});var date_label=Ti.UI.createLabel({id:'date_label',text:entry_date_time,width:1200,height:80,bottom:10,right:10,font:{fontSize:50},color:'white',opacity:0.5,textAlign:'right'});var item_label=Ti.UI.createLabel({width:'auto',height:'auto',borderColor:'transparent',borderWidth:1,font:{fontSize:50},textAlign:'center',opacity:1.0});var item_view=Ti.UI.createView({width:imageView.width,height:imageView.height,opacity:1.0});var scrollView_item=Ti.UI.createScrollView({contentWidth:'auto',contentHeight:'auto',contentOffset:{x:0,y:0},top:0,left:0,width:Ti.Platform.displayCaps.platformWidth,height:Ti.Platform.displayCaps.platformHeight,backgroundColor:'blue',opacity:0.1,maxZoomScale:2.0,minZoomScale:0.1});item_view.add(item_label);item_label.center=item_view.center;scrollView_item.add(item_view);win.add(scrollView_item);imageView.addEventListener('touchstart',function(e)
{Ti.API.debug('imageView touchstart.:'+e.source.getParent().getParent().title
+' x:'+e.x+' y:'+e.y+' type:'+e.type
+' globalPoint.x:'+e.globalPoint.x+' globalPoint.y:'+e.globalPoint.y);if(e.source.getParent().getParent().title==win.title){Ti.App.fireEvent('touch_continue',{timer:'start',x:e.x,y:e.y});}});imageView.addEventListener('touchmove',function(e)
{Ti.API.debug('imageView touchmove.:'+e.source
+' x:'+e.x+' y:'+e.y+' type:'+e.type);});imageView.addEventListener('touchend',function(e)
{Ti.API.debug('imageView touchend.:'+e.source
+' x:'+e.x+' y:'+e.y+' type:'+e.type);});imageView.addEventListener('click',function(e)
{Ti.API.debug('imageView click.:'+e.source
+' x:'+e.x+' y:'+e.y+' type:'+e.type);});imageView.addEventListener('dblclick',function(e)
{Ti.API.debug('imageView dblclick.:'+e.source
+' x:'+e.x+' y:'+e.y+' type:'+e.type);});function setLabel(){var label_text=Ti.App.Properties.getString("label_text");var label_text_color=Ti.App.Properties.getString("label_text_color");var label_back_color=Ti.App.Properties.getString("label_back_color");Ti.API.debug("setLabel:text "+label_text+' type:'+typeof(label_text)
+" label_text_color:"+label_text_color+' type:'+typeof(label_text_color)
+" label_back_color:"+label_back_color+' type:'+typeof(label_back_color));Ti.App.Properties.removeProperty("label_text");Ti.App.Properties.removeProperty("label_text_color");Ti.App.Properties.removeProperty("label_back_color");if(label_text==null){return;}
item_label.text=label_text;item_label.backgroundColor=label_back_color;item_label.color=label_text_color;}
imageView.add(memo_label);imageView.add(date_label);memo_label.hide();date_label.hide();var flexSpace=Ti.UI.createButton({systemButton:Ti.UI.iPhone.SystemButton.FLEXIBLE_SPACE});var b_memo_show_hide=Ti.UI.createButton({title:'show',style:Ti.UI.iPhone.SystemButtonStyle.BORDERED});b_memo_show_hide.addEventListener('click',function(e)
{if(memo_label.visible){memo_label.hide();date_label.hide();b_memo_show_hide.title='show';}else{memo_label.show();date_label.show();b_memo_show_hide.title='hide';}});var b_add2photo=Ti.UI.createButton({title:'add',style:Ti.UI.iPhone.SystemButtonStyle.BORDERED});b_add2photo.addEventListener('click',function(e)
{var memo_window=Ti.UI.createWindow({url:'memo_view_html.js',backgroundColor:'#fff',label_x:e.x,label_y:e.y});Ti.UI.currentTab.open(memo_window,{animated:true});});var b_undo_image=Ti.UI.createButton({title:'undo',style:Ti.UI.iPhone.SystemButtonStyle.DONE});b_undo_image.addEventListener('click',function(e)
{imageView.image=undo_image;});var b_put_image=Ti.UI.createButton({title:'put',style:Ti.UI.iPhone.SystemButtonStyle.BORDERED});var undo_image;b_put_image.addEventListener('click',function(e)
{imageView.add(item_view);undo_image=imageView.toBlob();imageView.image=imageView.toImage();imageView.remove(item_view);});var b_mail=Ti.UI.createButton({title:'mail',style:Ti.UI.iPhone.SystemButtonStyle.BORDERED});b_mail.addEventListener('click',function()
{var emailDialog=Ti.UI.createEmailDialog();emailDialog.setBarColor('#999');Ti.API.debug(win.title+' action:');if(!emailDialog.isSupported()){Ti.API.debug(win.title+' action:Email not available.');alert_dialog.message='Email not available';alert_dialog.show();return;}
emailDialog.setSubject('[TiPhotoMemo Mail]:'+entry_date_time+' captured.');if(memo_text){var memo_mes="Your photo memo is \n\n"+memo_text;}else{var memo_mes="photo memo is not set.";}
if(Ti.Platform.name=='iPhone OS'){emailDialog.setMessageBody(memo_mes);emailDialog.setHtml(false);}else{emailDialog.setMessageBody(memo_mes);}
emailDialog.addAttachment(image_file);emailDialog.addEventListener('complete',function(e)
{if(e.result==emailDialog.SENT){if(Ti.Platform.osname!='android'){alert_dialog.message='message was sent.';alert_dialog.show();}}else if(e.result==emailDialog.CANCELLED){}else{alert("message was not sent. "+e.result);}});emailDialog.open();});var b_save2roll=Ti.UI.createButton({title:'to roll',style:Ti.UI.iPhone.SystemButtonStyle.BORDERED});b_save2roll.addEventListener('click',function()
{navActInd.show();Ti.Media.saveToPhotoGallery(imageView.toImage(),{success:function(e){alert_dialog.message=L("add_photogallery_message_text");alert_dialog.show();navActInd.hide();},error:function(e){Ti.UI.createAlertDialog({title:'Error saving',message:e.error}).show();navActInd.hide();}});});var b_memo=Ti.UI.createButton({title:'memo',style:Ti.UI.iPhone.SystemButtonStyle.BORDERED});b_memo.addEventListener('click',function()
{var messageWindow=Ti.UI.createWindow({url:'message_window.js',title:L("memo_title_text"),image_id:win.image_id,backgroundColor:'#fff'});Ti.UI.currentTab.open(messageWindow,{animated:true});});win.addEventListener('focus',function(e)
{Ti.API.debug(win.title+' focus.');var db=Ti.Database.open('image.db');var rows=db.execute('SELECT * FROM t_image WHERE id = ? LIMIT 1',win.image_id);while(rows.isValidRow()){memo_text=rows.fieldByName('memo');entry_date_time=rows.fieldByName('entry_date')+' '+rows.fieldByName('entry_time');rows.next();}
rows.close();db.close();memo_label.text=memo_text;date_label.text=entry_date_time;setLabel();scrollView_item.show();});win.addEventListener('blur',function(e)
{Ti.API.debug(win.title+' blur.');});win.addEventListener('open',function(e)
{Ti.API.debug(win.title+' open.');scrollView.add(imageView);win.add(scrollView);win.toolbar=[b_memo,flexSpace,b_mail,flexSpace,b_memo_show_hide];win.setRightNavButton(b_save2roll);});win.addEventListener('close',function(e)
{Ti.API.debug(win.title+' close.');Ti.API.debug(win.title+' close.'+'array_memo_label:'+typeof(array_memo_label));for(var i=0,j=array_memo_label.length;i<j;i++){array_memo_label[i]=null;Ti.API.debug(win.title+' close.'+'array_memo_label['+i+'] set null:'+typeof(array_memo_label[i]));}
Ti.API.debug(win.title+' close.'+'emailDialog:'+typeof(emailDialog));Ti.API.debug(win.title+' close.'+'imageView.image:'+typeof(imageView.image));imageView=null;if(typeof(emailDialog)!=='undefined'){emailDialog=null;}});